<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:camunda="http://camunda.org/schema/1.0/bpmn" id="Definitions_1" targetNamespace="http://bpmn.io/schema/bpmn" exporter="Camunda Modeler" exporterVersion="1.8.2">
  <bpmn:process id="process_approval" name="Approval" isExecutable="true">
    <bpmn:startEvent id="start_event_approval_requested" name="Approval requested" camunda:formKey="embedded:app:request_approval.html">
      <bpmn:extensionElements>
        <camunda:executionListener delegateExpression="#{initProcessVariables}" event="end" />
      </bpmn:extensionElements>
      <bpmn:outgoing>SequenceFlow_0tr5j40</bpmn:outgoing>
    </bpmn:startEvent>
    <bpmn:sequenceFlow id="SequenceFlow_0tr5j40" sourceRef="start_event_approval_requested" targetRef="rule_task_determine_approval_steps" />
    <bpmn:sequenceFlow id="SequenceFlow_1dcbbx3" sourceRef="rule_task_determine_approvers" targetRef="sub_mi_execute_approval" />
    <bpmn:businessRuleTask id="rule_task_determine_approvers" name="Determine approvers" camunda:resultVariable="approverNames" camunda:decisionRef="determineApprovers" camunda:mapDecisionResult="singleEntry">
      <bpmn:extensionElements>
        <camunda:executionListener delegateExpression="#{buildApproversList}" event="end" />
      </bpmn:extensionElements>
      <bpmn:incoming>SequenceFlow_196d7jt</bpmn:incoming>
      <bpmn:outgoing>SequenceFlow_1dcbbx3</bpmn:outgoing>
    </bpmn:businessRuleTask>
    <bpmn:subProcess id="sub_mi_execute_approval" name="Execute approval step" camunda:asyncAfter="true">
      <bpmn:extensionElements>
        <camunda:executionListener delegateExpression="#{executeApprovalInitVariables}" event="start" />
      </bpmn:extensionElements>
      <bpmn:incoming>SequenceFlow_1dcbbx3</bpmn:incoming>
      <bpmn:outgoing>SequenceFlow_0rd01b6</bpmn:outgoing>
      <bpmn:multiInstanceLoopCharacteristics camunda:collection="${approversList}" camunda:elementVariable="approverName" />
      <bpmn:startEvent id="start_event_approval_step">
        <bpmn:outgoing>SequenceFlow_1sff65p</bpmn:outgoing>
      </bpmn:startEvent>
      <bpmn:userTask id="user_task_approve" name="Approve request" camunda:formKey="embedded:app:approve_request.html" camunda:assignee="${approverName}">
        <bpmn:incoming>SequenceFlow_1sff65p</bpmn:incoming>
        <bpmn:outgoing>SequenceFlow_0egn3kv</bpmn:outgoing>
      </bpmn:userTask>
      <bpmn:sequenceFlow id="SequenceFlow_1sff65p" sourceRef="start_event_approval_step" targetRef="user_task_approve" />
      <bpmn:exclusiveGateway id="ExclusiveGateway_1l5i010" name="Request approved?">
        <bpmn:incoming>SequenceFlow_0egn3kv</bpmn:incoming>
        <bpmn:outgoing>SequenceFlow_1sodrbc</bpmn:outgoing>
        <bpmn:outgoing>SequenceFlow_1ypiddj</bpmn:outgoing>
      </bpmn:exclusiveGateway>
      <bpmn:sequenceFlow id="SequenceFlow_0egn3kv" sourceRef="user_task_approve" targetRef="ExclusiveGateway_1l5i010" />
      <bpmn:endEvent id="end_event_approved" name="approved">
        <bpmn:incoming>SequenceFlow_1sodrbc</bpmn:incoming>
      </bpmn:endEvent>
      <bpmn:sequenceFlow id="SequenceFlow_1sodrbc" name="Yes" sourceRef="ExclusiveGateway_1l5i010" targetRef="end_event_approved">
        <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">#{approved}</bpmn:conditionExpression>
      </bpmn:sequenceFlow>
      <bpmn:sequenceFlow id="SequenceFlow_1ypiddj" name="No" sourceRef="ExclusiveGateway_1l5i010" targetRef="end_event_escalate_not_approved">
        <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">#{!approved}</bpmn:conditionExpression>
      </bpmn:sequenceFlow>
      <bpmn:endEvent id="end_event_escalate_not_approved" name="declined">
        <bpmn:incoming>SequenceFlow_1ypiddj</bpmn:incoming>
        <bpmn:escalationEventDefinition escalationRef="Escalation_1bp722w" />
      </bpmn:endEvent>
    </bpmn:subProcess>
    <bpmn:endEvent id="end_event_approval_finished" name="Approval finished">
      <bpmn:incoming>SequenceFlow_0hap8zn</bpmn:incoming>
      <bpmn:incoming>SequenceFlow_1iu2a4j</bpmn:incoming>
    </bpmn:endEvent>
    <bpmn:sequenceFlow id="SequenceFlow_0rd01b6" sourceRef="sub_mi_execute_approval" targetRef="ExclusiveGateway_09iaiax" />
    <bpmn:boundaryEvent id="boundary_catch_escalate_not_approved" name="Request declined" attachedToRef="sub_mi_execute_approval">
      <bpmn:outgoing>SequenceFlow_0hap8zn</bpmn:outgoing>
      <bpmn:escalationEventDefinition escalationRef="Escalation_1bp722w" />
    </bpmn:boundaryEvent>
    <bpmn:sequenceFlow id="SequenceFlow_0hap8zn" sourceRef="boundary_catch_escalate_not_approved" targetRef="end_event_approval_finished" />
    <bpmn:sequenceFlow id="SequenceFlow_1l21xf5" sourceRef="rule_task_determine_approval_steps" targetRef="ExclusiveGateway_0n53gkv" />
    <bpmn:businessRuleTask id="rule_task_determine_approval_steps" name="Determine number of approval steps" camunda:resultVariable="approvalSteps" camunda:decisionRef="determineApprovalSteps" camunda:mapDecisionResult="singleEntry">
      <bpmn:incoming>SequenceFlow_0tr5j40</bpmn:incoming>
      <bpmn:outgoing>SequenceFlow_1l21xf5</bpmn:outgoing>
    </bpmn:businessRuleTask>
    <bpmn:exclusiveGateway id="ExclusiveGateway_09iaiax" name="Further approval step required?" default="SequenceFlow_1iu2a4j">
      <bpmn:incoming>SequenceFlow_0rd01b6</bpmn:incoming>
      <bpmn:outgoing>SequenceFlow_1iu2a4j</bpmn:outgoing>
      <bpmn:outgoing>SequenceFlow_0rg0sl6</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:sequenceFlow id="SequenceFlow_1iu2a4j" name="No" sourceRef="ExclusiveGateway_09iaiax" targetRef="end_event_approval_finished" />
    <bpmn:sequenceFlow id="SequenceFlow_0rg0sl6" name="Yes" sourceRef="ExclusiveGateway_09iaiax" targetRef="script_task_set_next_step">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression"><![CDATA[${approvalSteps - stepNumber > 0}]]></bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:exclusiveGateway id="ExclusiveGateway_0n53gkv">
      <bpmn:incoming>SequenceFlow_1l21xf5</bpmn:incoming>
      <bpmn:incoming>SequenceFlow_1unq9ih</bpmn:incoming>
      <bpmn:outgoing>SequenceFlow_196d7jt</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:sequenceFlow id="SequenceFlow_196d7jt" sourceRef="ExclusiveGateway_0n53gkv" targetRef="rule_task_determine_approvers" />
    <bpmn:sequenceFlow id="SequenceFlow_1unq9ih" sourceRef="script_task_set_next_step" targetRef="ExclusiveGateway_0n53gkv" />
    <bpmn:scriptTask id="script_task_set_next_step" name="Set next approval step" scriptFormat="groovy">
      <bpmn:incoming>SequenceFlow_0rg0sl6</bpmn:incoming>
      <bpmn:outgoing>SequenceFlow_1unq9ih</bpmn:outgoing>
      <bpmn:script><![CDATA[execution.setVariable("stepNumber", ++stepNumber);
execution.removeVariable("approverNames");
execution.removeVariable("approversList");]]></bpmn:script>
    </bpmn:scriptTask>
  </bpmn:process>
  <bpmn:escalation id="Escalation_1bp722w" name="escalation_not_approved" escalationCode="NOK" />
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="process_approval">
      <bpmndi:BPMNShape id="_BPMNShape_StartEvent_2" bpmnElement="start_event_approval_requested">
        <dc:Bounds x="113" y="291" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="108" y="327" width="49" height="25" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="SequenceFlow_0tr5j40_di" bpmnElement="SequenceFlow_0tr5j40">
        <di:waypoint xsi:type="dc:Point" x="149" y="309" />
        <di:waypoint xsi:type="dc:Point" x="201" y="309" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="130" y="287.5" width="90" height="13" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNShape id="UserTask_0x9ux9u_di" bpmnElement="user_task_approve">
        <dc:Bounds x="715" y="270" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="EndEvent_0bhv4ma_di" bpmnElement="end_event_approval_finished">
        <dc:Bounds x="1277" y="291" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1252" y="262" width="85" height="13" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="SequenceFlow_1dcbbx3_di" bpmnElement="SequenceFlow_1dcbbx3">
        <di:waypoint xsi:type="dc:Point" x="545" y="309" />
        <di:waypoint xsi:type="dc:Point" x="602" y="309" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="528.5" y="287.5" width="90" height="13" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNShape id="BusinessRuleTask_19mc0uo_di" bpmnElement="rule_task_determine_approvers">
        <dc:Bounds x="445" y="269" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SubProcess_162dony_di" bpmnElement="sub_mi_execute_approval" isExpanded="true">
        <dc:Bounds x="602" y="209" width="477" height="278" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="StartEvent_1grc49k_di" bpmnElement="start_event_approval_step">
        <dc:Bounds x="634" y="292" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="607" y="331" width="90" height="13" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="SequenceFlow_1sff65p_di" bpmnElement="SequenceFlow_1sff65p">
        <di:waypoint xsi:type="dc:Point" x="670" y="310" />
        <di:waypoint xsi:type="dc:Point" x="715" y="310" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="648" y="288" width="90" height="13" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_0rd01b6_di" bpmnElement="SequenceFlow_0rd01b6">
        <di:waypoint xsi:type="dc:Point" x="1079" y="309" />
        <di:waypoint xsi:type="dc:Point" x="1130" y="309" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1059.5" y="287.5" width="90" height="13" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNShape id="ExclusiveGateway_1l5i010_di" bpmnElement="ExclusiveGateway_1l5i010" isMarkerVisible="true">
        <dc:Bounds x="861" y="285" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="860" y="249" width="52" height="25" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="SequenceFlow_0egn3kv_di" bpmnElement="SequenceFlow_0egn3kv">
        <di:waypoint xsi:type="dc:Point" x="815" y="310" />
        <di:waypoint xsi:type="dc:Point" x="861" y="310" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="793" y="288" width="90" height="13" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNShape id="EndEvent_0f1wn4u_di" bpmnElement="end_event_approved">
        <dc:Bounds x="991" y="292" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="986" y="331" width="46" height="13" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="SequenceFlow_1sodrbc_di" bpmnElement="SequenceFlow_1sodrbc">
        <di:waypoint xsi:type="dc:Point" x="911" y="310" />
        <di:waypoint xsi:type="dc:Point" x="991" y="310" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="938" y="284" width="18" height="12" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_1ypiddj_di" bpmnElement="SequenceFlow_1ypiddj">
        <di:waypoint xsi:type="dc:Point" x="886" y="335" />
        <di:waypoint xsi:type="dc:Point" x="886" y="380" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="896" y="345" width="15" height="12" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNShape id="EndEvent_1574c3p_di" bpmnElement="end_event_escalate_not_approved">
        <dc:Bounds x="868" y="380" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="866" y="425" width="41" height="12" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BoundaryEvent_16jtb2z_di" bpmnElement="boundary_catch_escalate_not_approved">
        <dc:Bounds x="989" y="469" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1021" y="510" width="85" height="13" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="SequenceFlow_0hap8zn_di" bpmnElement="SequenceFlow_0hap8zn">
        <di:waypoint xsi:type="dc:Point" x="1007" y="505" />
        <di:waypoint xsi:type="dc:Point" x="1007" y="567" />
        <di:waypoint xsi:type="dc:Point" x="1295" y="567" />
        <di:waypoint xsi:type="dc:Point" x="1295" y="327" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1106" y="545.5" width="90" height="13" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_1l21xf5_di" bpmnElement="SequenceFlow_1l21xf5">
        <di:waypoint xsi:type="dc:Point" x="301" y="309" />
        <di:waypoint xsi:type="dc:Point" x="341" y="309" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="321" y="287.5" width="0" height="13" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNShape id="BusinessRuleTask_1foqbg3_di" bpmnElement="rule_task_determine_approval_steps">
        <dc:Bounds x="201" y="269" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="ExclusiveGateway_09iaiax_di" bpmnElement="ExclusiveGateway_09iaiax" isMarkerVisible="true">
        <dc:Bounds x="1129.659405940594" y="284" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1114" y="337" width="81" height="25" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="SequenceFlow_1iu2a4j_di" bpmnElement="SequenceFlow_1iu2a4j">
        <di:waypoint xsi:type="dc:Point" x="1180" y="309" />
        <di:waypoint xsi:type="dc:Point" x="1277" y="309" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1221" y="288" width="15" height="13" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_0rg0sl6_di" bpmnElement="SequenceFlow_0rg0sl6">
        <di:waypoint xsi:type="dc:Point" x="1155" y="284" />
        <di:waypoint xsi:type="dc:Point" x="1155" y="120" />
        <di:waypoint xsi:type="dc:Point" x="891" y="120" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1164" y="207" width="18" height="13" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNShape id="ExclusiveGateway_0n53gkv_di" bpmnElement="ExclusiveGateway_0n53gkv" isMarkerVisible="true">
        <dc:Bounds x="340.65940594059407" y="284" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="365.65940594059407" y="337" width="0" height="13" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="SequenceFlow_196d7jt_di" bpmnElement="SequenceFlow_196d7jt">
        <di:waypoint xsi:type="dc:Point" x="391" y="309" />
        <di:waypoint xsi:type="dc:Point" x="445" y="309" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="418" y="287" width="0" height="13" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_1unq9ih_di" bpmnElement="SequenceFlow_1unq9ih">
        <di:waypoint xsi:type="dc:Point" x="791" y="120" />
        <di:waypoint xsi:type="dc:Point" x="366" y="120" />
        <di:waypoint xsi:type="dc:Point" x="366" y="284" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="578.5" y="98.5" width="0" height="13" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNShape id="ScriptTask_1m4e479_di" bpmnElement="script_task_set_next_step">
        <dc:Bounds x="791" y="81" width="100" height="80" />
      </bpmndi:BPMNShape>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>
